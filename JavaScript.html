<script>
/**
 * SISTEMA DE REPORTES ACADÉMICOS - CITEN
 * Archivo: JavaScript.html
 * Descripción: Lógica del frontend para el dashboard del estudiante
 * Versión: 2.0 (Arquitectura de carga de datos optimizada)
 */

// ============================================
// VARIABLES GLOBALES
// ============================================
let datosEstudiante = null;
let calificaciones = [];
let promedios = {};
let estadisticas = {};

// ============================================
// INICIALIZACIÓN
// ============================================
document.addEventListener('DOMContentLoaded', function() {
  inicializarSistema();
  configurarNavegacion();
  cargarGoogleCharts();
});

/**
 * VERSIÓN MEJORADA: Inicializa el sistema usando los datos ya cargados en la página.
 * Ya no llama al servidor, eliminando el riesgo de error asíncrono.
 */
function inicializarSistema() {
  mostrarLoader();
  
  // La variable 'initialData' se crea en el archivo Estudiante.html
  // y contiene todos los datos necesarios desde el inicio.
  if (typeof initialData !== 'undefined' && initialData && !initialData.error) {
    // Si los datos existen y no hay un error, procesarlos.
    procesarDatosEstudiante(initialData);
  } else {
    // Si hay un error o los datos no se cargaron, mostrar un mensaje.
    const errorMessage = initialData ? initialData.error : "No se pudieron cargar los datos iniciales del servidor.";
    mostrarError(errorMessage);
  }
}

/**
 * Procesa los datos recibidos (ahora de forma local y síncrona).
 */
function procesarDatosEstudiante(datos) {
  datosEstudiante = datos.usuario;
  calificaciones = datos.calificaciones;
  promedios = datos.promedios;
  estadisticas = datos.estadisticas;
  
  // Actualizar toda la interfaz de usuario con los datos cargados
  actualizarResumenGeneral();
  actualizarSidebar();
  cargarUltimasCalificaciones();
  cargarAreasDetalle();
  cargarCompetenciasDetalle();
  cargarHistorico();
  cargarTodasCalificaciones();
  cargarFiltros();
  
  ocultarLoader(); // Oculta el loader y dibuja los gráficos
}

// ============================================
// NAVEGACIÓN
// ============================================
function configurarNavegacion() {
  const navLinks = document.querySelectorAll('.sidebar-nav a');
  const sections = document.querySelectorAll('.content-section');
  
  navLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      
      const targetId = this.getAttribute('data-target');
      
      navLinks.forEach(l => l.classList.remove('active'));
      this.classList.add('active');
      
      sections.forEach(s => s.classList.remove('active'));
      
      const targetSection = document.getElementById(targetId);
      if (targetSection) {
        targetSection.classList.add('active');
      }
    });
  });
}

// ============================================
// ACTUALIZACIÓN DE RESUMEN GENERAL
// ============================================
function actualizarResumenGeneral() {
  const promedioGeneral = promedios.general || 0;
  const nivelGeneral = obtenerNivelLogro(promedioGeneral);
  
  document.getElementById('promedio-general').textContent = promedioGeneral;
  const nivelElement = document.getElementById('nivel-general');
  nivelElement.textContent = nivelGeneral;
  nivelElement.className = 'stat-badge nivel-' + nivelGeneral;
  
  document.getElementById('total-ad').textContent = estadisticas.porNivel.AD || 0;
  document.getElementById('total-evaluaciones').textContent = estadisticas.total || 0;
  
  let areasRiesgo = 0;
  for (let area in promedios.porArea) {
    if (parseFloat(promedios.porArea[area].promedio) < 14) {
      areasRiesgo++;
    }
  }
  document.getElementById('areas-riesgo').textContent = areasRiesgo;
}

function actualizarSidebar() {
  const promedioGeneral = promedios.general || 0;
  const nivelGeneral = obtenerNivelLogro(promedioGeneral);
  
  document.getElementById('promedio-sidebar').textContent = promedioGeneral;
  document.getElementById('nivel-sidebar').textContent = obtenerTextoNivel(nivelGeneral);
}

// ============================================
// ÚLTIMAS CALIFICACIONES
// ============================================
function cargarUltimasCalificaciones() {
  const tbody = document.getElementById('ultimas-notas');
  tbody.innerHTML = '';
  
  if (!calificaciones || calificaciones.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay calificaciones registradas</td></tr>';
    return;
  }
  
  const ultimas = calificaciones
    .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))
    .slice(0, 5);
  
  ultimas.forEach(cal => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${formatearFecha(cal.fecha)}</td>
      <td>${cal.area}</td>
      <td>${truncarTexto(cal.competencia, 40)}</td>
      <td><span class="nivel-badge nivel-${cal.calificacion}">${cal.calificacion}</span></td>
      <td><strong>${cal.calificacionNum}</strong></td>
      <td>${cal.retroalimentacion || '<em class="text-muted">Sin retroalimentación</em>'}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ============================================
// ÁREAS CURRICULARES
// ============================================
function cargarAreasDetalle() {
  const container = document.getElementById('areas-container');
  container.innerHTML = '';
  
  if (!promedios.porArea || Object.keys(promedios.porArea).length === 0) {
    container.innerHTML = '<div class="col-12"><p class="text-center text-muted">No hay datos de áreas disponibles</p></div>';
    return;
  }
  
  for (let area in promedios.porArea) {
    const datos = promedios.porArea[area];
    const promedio = datos.promedio;
    const nivel = obtenerNivelLogro(promedio);
    const colorBorde = obtenerColorNivel(nivel);
    
    const competenciasArea = {};
    for (let comp in promedios.porCompetencia) {
      if (promedios.porCompetencia[comp].area === area) {
        competenciasArea[comp] = promedios.porCompetencia[comp];
      }
    }
    
    const cardHTML = `
      <div class="col-md-6">
        <div class="area-card" style="border-left-color: ${colorBorde};">
          <div class="area-header">
            <h4>${area}</h4>
            <div class="area-promedio">
              <span class="area-promedio-valor">${promedio}</span>
              <span class="nivel-badge nivel-${nivel}">${nivel}</span>
            </div>
          </div>
          <div class="competencias-list">
            ${generarListaCompetencias(competenciasArea)}
          </div>
        </div>
      </div>
    `;
    container.innerHTML += cardHTML;
  }
}

function generarListaCompetencias(competencias) {
  let html = '';
  if (Object.keys(competencias).length === 0) {
    return '<p class="text-muted small px-3">No hay competencias registradas para esta área.</p>';
  }
  
  for (let comp in competencias) {
    const datos = competencias[comp];
    const promedio = datos.promedio;
    const nivel = obtenerNivelLogro(promedio);
    const nombreComp = comp.split(' - ')[1] || comp;
    
    html += `
      <div class="competencia-item">
        <span class="competencia-nombre">${truncarTexto(nombreComp, 50)}</span>
        <div class="competencia-nota">
          <strong>${promedio}</strong>
          <span class="nivel-badge nivel-${nivel}">${nivel}</span>
        </div>
      </div>
    `;
  }
  return html;
}

// ============================================
// COMPETENCIAS DETALLADAS
// ============================================
function cargarCompetenciasDetalle() {
  const container = document.getElementById('competencias-container');
  container.innerHTML = '';
  
  if (!promedios.porCompetencia || Object.keys(promedios.porCompetencia).length === 0) {
    container.innerHTML = '<p class="text-center text-muted">No hay datos de competencias disponibles</p>';
    return;
  }
  
  for (let comp in promedios.porCompetencia) {
    const datos = promedios.porCompetencia[comp];
    const promedio = datos.promedio;
    const nivel = obtenerNivelLogro(promedio);
    const [area, competencia] = comp.split(' - ');
    
    const cardHTML = `
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div style="flex: 1;">
              <h5><i class="fas fa-check-circle text-success"></i> ${competencia}</h5>
              <p class="text-muted mb-2"><i class="fas fa-book"></i> ${area}</p>
            </div>
            <div class="text-right">
              <div style="font-size: 2em; font-weight: 700; color: var(--citen-azul-oscuro);">${promedio}</div>
              <span class="nivel-badge nivel-${nivel}">${nivel}</span>
            </div>
          </div>
          <div class="progress mt-3" style="height: 10px;">
            <div class="progress-bar" role="progressbar" style="width: ${(promedio/20)*100}%; background: ${obtenerColorNivel(nivel)};" aria-valuenow="${promedio}" aria-valuemin="0" aria-valuemax="20"></div>
          </div>
        </div>
      </div>
    `;
    container.innerHTML += cardHTML;
  }
}

// ============================================
// HISTÓRICO
// ============================================
function cargarHistorico() {
  const tbody = document.getElementById('tabla-periodos');
  tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Función de histórico no implementada en esta versión.</td></tr>';
}

// ============================================
// TODAS LAS CALIFICACIONES Y FILTROS
// ============================================
function cargarTodasCalificaciones(calificacionesAMostrar = null) {
  const tbody = document.getElementById('tabla-calificaciones');
  tbody.innerHTML = '';
  
  const data = calificacionesAMostrar || calificaciones;
  
  if (!data || data.length === 0) {
    const message = calificacionesAMostrar ? 'No hay calificaciones que coincidan con los filtros' : 'No hay calificaciones registradas';
    tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">${message}</td></tr>`;
    return;
  }
  
  const ordenadas = data.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
  
  ordenadas.forEach(cal => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${formatearFecha(cal.fecha)}</td>
      <td>${cal.area}</td>
      <td>${cal.competencia}</td>
      <td><span class="nivel-badge nivel-${cal.calificacion}">${cal.calificacion}</span></td>
      <td><strong>${cal.calificacionNum}</strong></td>
      <td>${cal.periodo}</td>
      <td>${cal.retroalimentacion || '<em class="text-muted">-</em>'}</td>
    `;
    tbody.appendChild(tr);
  });
}

function cargarFiltros() {
  const areas = [...new Set(calificaciones.map(c => c.area))].sort();
  const periodos = [...new Set(calificaciones.map(c => c.periodo))].sort();
  
  const selectArea = document.getElementById('filtro-area');
  areas.forEach(area => {
    const option = document.createElement('option');
    option.value = area;
    option.textContent = area;
    selectArea.appendChild(option);
  });
  
  const selectPeriodo = document.getElementById('filtro-periodo');
  periodos.forEach(periodo => {
    const option = document.createElement('option');
    option.value = periodo;
    option.textContent = periodo;
    selectPeriodo.appendChild(option);
  });
}

function aplicarFiltros() {
  const areaSeleccionada = document.getElementById('filtro-area').value;
  const periodoSeleccionado = document.getElementById('filtro-periodo').value;
  
  let calificacionesFiltradas = calificaciones;
  
  if (areaSeleccionada) {
    calificacionesFiltradas = calificacionesFiltradas.filter(c => c.area === areaSeleccionada);
  }
  
  if (periodoSeleccionado) {
    calificacionesFiltradas = calificacionesFiltradas.filter(c => c.periodo === periodoSeleccionado);
  }
  
  cargarTodasCalificaciones(calificacionesFiltradas);
}

// ============================================
// GRÁFICOS CON GOOGLE CHARTS
// ============================================
function cargarGoogleCharts() {
  google.charts.load('current', {'packages':['corechart', 'bar']});
  google.charts.setOnLoadCallback(dibujarTodosGraficos);
}

function dibujarGraficoAreas() {
  if (!promedios.porArea || Object.keys(promedios.porArea).length === 0) return;
  
  const datos = [['Área', 'Promedio', { role: 'style' }]];
  for (let area in promedios.porArea) {
    const prom = parseFloat(promedios.porArea[area].promedio);
    const nivel = obtenerNivelLogro(prom);
    datos.push([area, prom, obtenerColorNivel(nivel)]);
  }
  
  const data = google.visualization.arrayToDataTable(datos);
  const options = {
    title: 'Promedio por Área Curricular',
    chartArea: {width: '70%'},
    hAxis: { title: 'Promedio', minValue: 0, maxValue: 20 },
    vAxis: { title: 'Área Curricular' },
    legend: { position: 'none' }
  };
  
  const chart = new google.visualization.BarChart(document.getElementById('chart-areas'));
  chart.draw(data, options);
}

function dibujarGraficoDistribucion() {
  if (!estadisticas.porNivel) return;
  
  const datos = [
    ['Nivel', 'Cantidad'],
    ['AD - Logro Destacado', estadisticas.porNivel.AD || 0],
    ['A - Logro Esperado', estadisticas.porNivel.A || 0],
    ['B - En Proceso', estadisticas.porNivel.B || 0],
    ['C - En Inicio', estadisticas.porNivel.C || 0]
  ];
  
  const data = google.visualization.arrayToDataTable(datos);
  const options = {
    title: 'Distribución de Niveles de Logro',
    pieHole: 0.4,
    colors: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444'],
    legend: { position: 'bottom' }
  };
  
  const chart = new google.visualization.PieChart(document.getElementById('chart-distribucion'));
  chart.draw(data, options);
}

function dibujarTodosGraficos() {
  if (typeof google.visualization === 'undefined' || typeof google.visualization.arrayToDataTable === 'undefined') {
    // Si la librería no ha cargado, esperar un poco y reintentar.
    setTimeout(dibujarTodosGraficos, 100);
    return;
  }
  dibujarGraficoAreas();
  dibujarGraficoDistribucion();
}

// ============================================
// FUNCIONES AUXILIARES
// ============================================
function obtenerNivelLogro(promedio) {
  const nota = parseFloat(promedio);
  if (isNaN(nota)) return 'C';
  if (nota >= 18) return 'AD';
  if (nota >= 14) return 'A';
  if (nota >= 11) return 'B';
  return 'C';
}

function obtenerTextoNivel(nivel) {
  const niveles = {'AD': 'Logro Destacado', 'A': 'Logro Esperado', 'B': 'En Proceso', 'C': 'En Inicio'};
  return niveles[nivel] || 'Sin Nivel';
}

function obtenerColorNivel(nivel) {
  const colores = {'AD': '#10b981', 'A': '#3b82f6', 'B': '#f59e0b', 'C': '#ef4444'};
  return colores[nivel] || '#6b7280';
}

function formatearFecha(fechaStr) {
  if (!fechaStr) return '';
  const date = new Date(fechaStr);
  if (isNaN(date.getTime())) return fechaStr; // Devuelve original si es inválido
  return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function truncarTexto(texto, maxLength) {
  if (!texto || texto.length <= maxLength) return texto;
  return texto.substring(0, maxLength) + '...';
}

// ============================================
// LOADER Y MANEJO DE ERRORES
// ============================================
function mostrarLoader() {
  const loader = document.getElementById('global-loader');
  if (loader) loader.style.display = 'flex';
}

function ocultarLoader() {
  const loader = document.getElementById('global-loader');
  if (loader) loader.style.display = 'none';
  dibujarTodosGraficos(); // Dibujar gráficos una vez que todo esté listo
}

function mostrarError(error) {
  ocultarLoader();
  console.error('Error:', error);
  // Reemplaza el contenido principal con un mensaje de error claro
  const contentArea = document.querySelector('.content-area');
  contentArea.innerHTML = `
    <div class="container text-center mt-5">
      <div class="card p-5" style="background: #fff3f3; border: 2px solid #ef4444;">
        <h2 class="text-danger"><i class="fas fa-exclamation-triangle"></i> Se ha producido un error</h2>
        <p class="mt-3">No se pudieron cargar tus datos académicos.</p>
        <p><strong>Detalle:</strong> ${error}</p>
        <button class="btn btn-primary mt-3" onclick="window.location.reload();">
          <i class="fas fa-sync-alt"></i> Recargar Página
        </button>
      </div>
    </div>
  `;
}

</script>
