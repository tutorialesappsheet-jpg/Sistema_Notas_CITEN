<script>
/**
 * SISTEMA DE REPORTES ACADÉMICOS - CITEN
 * Archivo: JavaScript.html
 * Versión: 2.2 - Estilos de Reporte de Notas Mejorados
 */

// ============================================
// VARIABLES GLOBALES
// ============================================
let datosEstudiante = null;
let calificaciones = [];
let promedios = {};
let estadisticas = {};
let historico = [];
let reporte = {};

// ============================================
// INICIALIZACIÓN
// ============================================
document.addEventListener('DOMContentLoaded', function() {
  inicializarSistema();
  configurarNavegacion();
  cargarGoogleCharts();
});

function inicializarSistema() {
  mostrarLoader();
  if (typeof initialData !== 'undefined' && initialData && !initialData.error) {
    procesarDatosEstudiante(initialData);
  } else {
    const errorMessage = initialData ? initialData.error : "No se pudieron cargar los datos iniciales.";
    mostrarError(errorMessage);
  }
}

function procesarDatosEstudiante(datos) {
  datosEstudiante = datos.usuario;
  calificaciones = datos.calificaciones;
  promedios = datos.promedios;
  estadisticas = datos.estadisticas;
  historico = datos.historico;
  reporte = datos.reporte;
  
  actualizarResumenGeneral();
  actualizarSidebar();
  cargarUltimasCalificaciones();
  cargarAreasDetalle();
  cargarCompetenciasDetalle();
  cargarHistorico();
  cargarTodasCalificaciones();
  cargarFiltros();
  cargarReporteNotas();
  
  ocultarLoader();
}

// ============================================
// NAVEGACIÓN
// ============================================
function configurarNavegacion() {
  const navLinks = document.querySelectorAll('.sidebar-nav a');
  const sections = document.querySelectorAll('.content-section');
  
  navLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const targetId = this.getAttribute('data-target');
      navLinks.forEach(l => l.classList.remove('active'));
      this.classList.add('active');
      sections.forEach(s => s.classList.remove('active'));
      const targetSection = document.getElementById(targetId);
      if (targetSection) {
        targetSection.classList.add('active');
      }
    });
  });
}

// ============================================
// SECCIONES DEL DASHBOARD
// ============================================

function actualizarResumenGeneral() {
  const promedioGeneral = promedios.general || 0;
  const nivelGeneral = obtenerNivelLogro(promedioGeneral);
  
  document.getElementById('promedio-general').textContent = promedioGeneral;
  const nivelElement = document.getElementById('nivel-general');
  nivelElement.textContent = nivelGeneral;
  nivelElement.className = 'stat-badge nivel-' + nivelGeneral;
  
  document.getElementById('total-ad').textContent = estadisticas.porNivel.AD || 0;
  document.getElementById('total-evaluaciones').textContent = estadisticas.total || 0;
  
  let areasRiesgo = 0;
  for (let area in promedios.porArea) {
    if (parseFloat(promedios.porArea[area].promedio) < 14) {
      areasRiesgo++;
    }
  }
  document.getElementById('areas-riesgo').textContent = areasRiesgo;
}

function actualizarSidebar() {
  const promedioGeneral = promedios.general || 0;
  const nivelGeneral = obtenerNivelLogro(promedioGeneral);
  
  document.getElementById('promedio-sidebar').textContent = promedioGeneral;
  document.getElementById('nivel-sidebar').textContent = obtenerTextoNivel(nivelGeneral);
}

function cargarUltimasCalificaciones() {
  const tbody = document.getElementById('ultimas-notas');
  tbody.innerHTML = '';
  
  if (!calificaciones || calificaciones.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay calificaciones registradas</td></tr>';
    return;
  }
  
  const ultimas = [...calificaciones].sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).slice(0, 5);
  
  ultimas.forEach(cal => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${formatearFecha(cal.fecha)}</td>
      <td>${cal.area}</td>
      <td>${truncarTexto(cal.competencia, 40)}</td>
      <td><span class="nivel-badge nivel-${cal.calificacion}">${cal.calificacion}</span></td>
      <td><strong>${cal.calificacionNum}</strong></td>
      <td>${cal.retroalimentacion || '<em class="text-muted">Sin retroalimentación</em>'}</td>
    `;
    tbody.appendChild(tr);
  });
}

function cargarAreasDetalle() {
  const container = document.getElementById('areas-container');
  container.innerHTML = '';
  
  if (!promedios.porArea || Object.keys(promedios.porArea).length === 0) {
    container.innerHTML = '<div class="col-12"><p class="text-center text-muted">No hay datos de áreas disponibles</p></div>';
    return;
  }
  
  for (let area in promedios.porArea) {
    const datos = promedios.porArea[area];
    const promedio = datos.promedio;
    const nivel = obtenerNivelLogro(promedio);
    const colorBorde = obtenerColorNivel(nivel);
    
    const competenciasArea = {};
    for (let comp in promedios.porCompetencia) {
      if (promedios.porCompetencia[comp].area === area) {
        competenciasArea[comp] = promedios.porCompetencia[comp];
      }
    }
    
    const cardHTML = `
      <div class="col-md-6">
        <div class="area-card" style="border-left-color: ${colorBorde};">
          <div class="area-header">
            <h4>${area}</h4>
            <div class="area-promedio">
              <span class="area-promedio-valor">${promedio}</span>
              <span class="nivel-badge nivel-${nivel}">${nivel}</span>
            </div>
          </div>
          <div class="competencias-list">
            ${generarListaCompetencias(competenciasArea)}
          </div>
        </div>
      </div>
    `;
    container.innerHTML += cardHTML;
  }
}

function generarListaCompetencias(competencias) {
  let html = '';
  if (Object.keys(competencias).length === 0) {
    return '<p class="text-muted small px-3">No hay competencias registradas para esta área.</p>';
  }
  
  for (let comp in competencias) {
    const datos = competencias[comp];
    const promedio = datos.promedio;
    const nivel = obtenerNivelLogro(promedio);
    const nombreComp = comp.split(' - ')[1] || comp;
    
    html += `
      <div class="competencia-item">
        <span class="competencia-nombre">${truncarTexto(nombreComp, 50)}</span>
        <div class="competencia-nota">
          <strong>${promedio}</strong>
          <span class="nivel-badge nivel-${nivel}">${nivel}</span>
        </div>
      </div>
    `;
  }
  return html;
}

function cargarCompetenciasDetalle() {
  const container = document.getElementById('competencias-container');
  container.innerHTML = '';
  
  if (!promedios.porCompetencia || Object.keys(promedios.porCompetencia).length === 0) {
    container.innerHTML = '<p class="text-center text-muted">No hay datos de competencias disponibles</p>';
    return;
  }
  
  for (let comp in promedios.porCompetencia) {
    const datos = promedios.porCompetencia[comp];
    const promedio = datos.promedio;
    const nivel = obtenerNivelLogro(promedio);
    const [area, competencia] = comp.split(' - ');
    
    const cardHTML = `
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div style="flex: 1;">
              <h5><i class="fas fa-check-circle text-success"></i> ${competencia}</h5>
              <p class="text-muted mb-2"><i class="fas fa-book"></i> ${area}</p>
            </div>
            <div class="text-right">
              <div style="font-size: 2em; font-weight: 700; color: var(--citen-azul-oscuro);">${promedio}</div>
              <span class="nivel-badge nivel-${nivel}">${nivel}</span>
            </div>
          </div>
          <div class="progress mt-3" style="height: 10px;">
            <div class="progress-bar" role="progressbar" style="width: ${(promedio/20)*100}%; background: ${obtenerColorNivel(nivel)};" aria-valuenow="${promedio}" aria-valuemin="0" aria-valuemax="20"></div>
          </div>
        </div>
      </div>
    `;
    container.innerHTML += cardHTML;
  }
}

function cargarHistorico() {
  const tbody = document.getElementById('tabla-periodos');
  if (!historico || historico.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay datos históricos para mostrar.</td></tr>';
    return;
  }

  tbody.innerHTML = '';
  let promedioAnterior = 0;

  historico.forEach((periodo, index) => {
    let tendenciaHTML = '';
    const promedioActual = parseFloat(periodo.promedio);

    if (index > 0) {
      if (promedioActual > promedioAnterior) {
        tendenciaHTML = '<span class="text-success"><i class="fas fa-arrow-up"></i> Mejora</span>';
      } else if (promedioActual < promedioAnterior) {
        tendenciaHTML = '<span class="text-danger"><i class="fas fa-arrow-down"></i> Descenso</span>';
      } else {
        tendenciaHTML = '<span class="text-muted"><i class="fas fa-equals"></i> Estable</span>';
      }
    } else {
      tendenciaHTML = '<span class="text-muted">-</span>';
    }
    promedioAnterior = promedioActual;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${periodo.periodo}</strong></td>
      <td>${periodo.promedio}</td>
      <td><span class="nivel-badge nivel-${periodo.nivelLogro}">${periodo.nivelLogro}</span></td>
      <td>${periodo.totalNotas}</td>
      <td>${tendenciaHTML}</td>
    `;
    tbody.appendChild(tr);
  });
}

function cargarTodasCalificaciones(calificacionesAMostrar = null) {
  const tbody = document.getElementById('tabla-calificaciones');
  tbody.innerHTML = '';
  
  const data = calificacionesAMostrar || calificaciones;
  
  if (!data || data.length === 0) {
    const message = calificacionesAMostrar ? 'No hay calificaciones que coincidan con los filtros' : 'No hay calificaciones registradas';
    tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">${message}</td></tr>`;
    return;
  }
  
  const ordenadas = [...data].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
  
  ordenadas.forEach(cal => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${formatearFecha(cal.fecha)}</td>
      <td>${cal.area}</td>
      <td>${cal.competencia}</td>
      <td><span class="nivel-badge nivel-${cal.calificacion}">${cal.calificacion}</span></td>
      <td><strong>${cal.calificacionNum}</strong></td>
      <td>${cal.periodo}</td>
      <td>${cal.retroalimentacion || '<em class="text-muted">-</em>'}</td>
    `;
    tbody.appendChild(tr);
  });
}

function cargarFiltros() {
  const areas = [...new Set(calificaciones.map(c => c.area))].sort();
  const periodos = [...new Set(calificaciones.map(c => c.periodo))].sort();
  
  const selectArea = document.getElementById('filtro-area');
  selectArea.innerHTML = '<option value="">Todas las áreas</option>';
  areas.forEach(area => {
    const option = document.createElement('option');
    option.value = area;
    option.textContent = area;
    selectArea.appendChild(option);
  });
  
  const selectPeriodo = document.getElementById('filtro-periodo');
  selectPeriodo.innerHTML = '<option value="">Todos los periodos</option>';
  periodos.forEach(periodo => {
    const option = document.createElement('option');
    option.value = periodo;
    option.textContent = periodo;
    selectPeriodo.appendChild(option);
  });
}

function aplicarFiltros() {
  const areaSeleccionada = document.getElementById('filtro-area').value;
  const periodoSeleccionado = document.getElementById('filtro-periodo').value;
  
  let calificacionesFiltradas = calificaciones;
  
  if (areaSeleccionada) {
    calificacionesFiltradas = calificacionesFiltradas.filter(c => c.area === areaSeleccionada);
  }
  
  if (periodoSeleccionado) {
    calificacionesFiltradas = calificacionesFiltradas.filter(c => c.periodo === periodoSeleccionado);
  }
  
  cargarTodasCalificaciones(calificacionesFiltradas);
}

// Reemplaza esta función en JavaScript.html

function cargarReporteNotas() {
  const container = document.getElementById('reporte-container');
  // Usamos el nuevo objeto de datos: 'reporteSIGAN'
  const reporteSIGAN = initialData.reporteSIGAN; 

  if (!reporteSIGAN || Object.keys(reporteSIGAN).length === 0) {
    container.innerHTML = '<p class="text-center text-muted py-5">No hay datos suficientes para generar el Reporte de Notas.</p>';
    return;
  }

  let html = `<p><strong>Estudiante:</strong> ${datosEstudiante.apellidos}, ${datosEstudiante.nombres}</p>`;

  for (const area in reporteSIGAN) {
    const dataArea = reporteSIGAN[area];
    html += `<h4 class="reporte-area-header mt-4">${area}</h4>`;
    html += `
      <div class="table-responsive">
        <table class="sigan-table">
          <thead>
            <tr class="header-l1">
              <th rowspan="3" style="width: 20%;">Asignatura</th>
              <th colspan="3">(1) Indicadores de logro 1</th>
              <th colspan="3">(2) Indicadores de logro 2</th>
              <th colspan="3">(3) Indicadores de logro 3</th>
              <th colspan="2">(4) Examen Final</th>
              <th rowspan="3" class="promedio-final-col">Promedio Final</th>
            </tr>
            <tr class="header-l2">
              <!-- Indicador 1 -->
              <th>Comp 1</th><th>Comp 2</th><th class="promedio-col">Promedio</th>
              <!-- Indicador 2 -->
              <th>Comp 1</th><th>Comp 2</th><th class="promedio-col">Promedio</th>
              <!-- Indicador 3 -->
              <th>Comp 1</th><th>Comp 2</th><th class="promedio-col">Promedio</th>
              <!-- Examen Final -->
              <th>EF1</th><th class="promedio-col">Promedio</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="student-info-col">${area}</td>
              <!-- Indicador 1 -->
              <td>${dataArea.indicadores['Indicadores de logro 1']['Resuelve problemas de cantidad'] || '0.00'}</td>
              <td>${'0.00'}</td>
              <td class="promedio-col">${dataArea.indicadores['Indicadores de logro 1'].promedio}</td>
              <!-- Indicador 2 -->
              <td>${dataArea.indicadores['Indicadores de logro 2']['Resuelve problemas de regularidad'] || '0.00'}</td>
              <td>${'0.00'}</td>
              <td class="promedio-col">${dataArea.indicadores['Indicadores de logro 2'].promedio}</td>
              <!-- Indicador 3 -->
              <td>${'0.00'}</td>
              <td>${'0.00'}</td>
              <td class="promedio-col">${dataArea.indicadores['Indicadores de logro 3'].promedio}</td>
              <!-- Examen Final -->
              <td>${dataArea.indicadores['Examen Final']['Examen Final de Matemática'] || '0.00'}</td>
              <td class="promedio-col">${dataArea.indicadores['Examen Final'].promedio}</td>
              <td class="promedio-final-col">${dataArea.promedioFinal}</td>
            </tr>
          </tbody>
        </table>
      </div>
    `;
  }
  container.innerHTML = html;
}

// ============================================
// GRÁFICOS CON GOOGLE CHARTS
// ============================================
function cargarGoogleCharts() {
  google.charts.load('current', {'packages':['corechart']});
  google.charts.setOnLoadCallback(dibujarTodosGraficos);
}

function dibujarGraficoAreas() {
  if (!promedios.porArea || Object.keys(promedios.porArea).length === 0) return;
  
  const datos = [['Área', 'Promedio', { role: 'style' }]];
  for (let area in promedios.porArea) {
    const prom = parseFloat(promedios.porArea[area].promedio);
    const nivel = obtenerNivelLogro(prom);
    datos.push([area, prom, obtenerColorNivel(nivel)]);
  }
  
  const data = google.visualization.arrayToDataTable(datos);
  const options = {
    title: 'Promedio por Área Curricular',
    chartArea: {width: '70%'},
    hAxis: { title: 'Promedio', minValue: 0, maxValue: 20 },
    vAxis: { title: 'Área Curricular' },
    legend: { position: 'none' }
  };
  
  const chart = new google.visualization.BarChart(document.getElementById('chart-areas'));
  chart.draw(data, options);
}

function dibujarGraficoDistribucion() {
  if (!estadisticas.porNivel) return;
  
  const datos = [
    ['Nivel', 'Cantidad'],
    ['AD - Logro Destacado', estadisticas.porNivel.AD || 0],
    ['A - Logro Esperado', estadisticas.porNivel.A || 0],
    ['B - En Proceso', estadisticas.porNivel.B || 0],
    ['C - En Inicio', estadisticas.porNivel.C || 0]
  ];
  
  const data = google.visualization.arrayToDataTable(datos);
  const options = {
    title: 'Distribución de Niveles de Logro',
    pieHole: 0.4,
    colors: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444'],
    legend: { position: 'bottom' }
  };
  
  const chart = new google.visualization.PieChart(document.getElementById('chart-distribucion'));
  chart.draw(data, options);
}

function dibujarGraficoEvolucion() {
  const container = document.getElementById('chart-evolucion');
  if (!historico || historico.length < 2) {
    container.innerHTML = '<p class="text-center text-muted mt-5">Se necesitan al menos dos periodos con notas para mostrar la evolución.</p>';
    return;
  }
  const datosGrafico = [['Periodo', 'Promedio']];
  historico.forEach(periodo => {
    datosGrafico.push([periodo.periodo, parseFloat(periodo.promedio)]);
  });
  const data = google.visualization.arrayToDataTable(datosGrafico);
  const options = {
    title: 'Evolución del Promedio por Periodo',
    curveType: 'function',
    legend: { position: 'bottom' },
    vAxis: { 
      title: 'Promedio',
      viewWindow: { min: 0, max: 20 }
    },
    colors: ['#003366'],
    pointSize: 7
  };
  const chart = new google.visualization.LineChart(container);
  chart.draw(data, options);
}

function dibujarTodosGraficos() {
  if (typeof google.visualization === 'undefined' || typeof google.visualization.arrayToDataTable === 'undefined') {
    setTimeout(dibujarTodosGraficos, 100);
    return;
  }
  dibujarGraficoAreas();
  dibujarGraficoDistribucion();
  dibujarGraficoEvolucion();
}

// ============================================
// FUNCIONES AUXILIARES
// ============================================
function obtenerNivelLogro(promedio) {
  const nota = parseFloat(promedio);
  if (isNaN(nota)) return 'C';
  if (nota >= 18) return 'AD';
  if (nota >= 14) return 'A';
  if (nota >= 11) return 'B';
  return 'C';
}

function obtenerTextoNivel(nivel) {
  const niveles = {'AD': 'Logro Destacado', 'A': 'Logro Esperado', 'B': 'En Proceso', 'C': 'En Inicio'};
  return niveles[nivel] || 'Sin Nivel';
}

function obtenerColorNivel(nivel) {
  const colores = {'AD': '#10b981', 'A': '#3b82f6', 'B': '#f59e0b', 'C': '#ef4444'};
  return colores[nivel] || '#6b7280';
}

function formatearFecha(fechaStr) {
  if (!fechaStr) return '';
  const date = new Date(fechaStr);
  if (isNaN(date.getTime())) return fechaStr;
  return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'UTC' });
}

function truncarTexto(texto, maxLength) {
  if (!texto || texto.length <= maxLength) return texto;
  return texto.substring(0, maxLength) + '...';
}

// ============================================
// LOADER Y MANEJO DE ERRORES
// ============================================
function mostrarLoader() {
  const loader = document.getElementById('global-loader');
  if (loader) loader.style.display = 'flex';
}

function ocultarLoader() {
  const loader = document.getElementById('global-loader');
  if (loader) loader.style.display = 'none';
  dibujarTodosGraficos();
}

function mostrarError(error) {
  ocultarLoader();
  console.error('Error:', error);
  const contentArea = document.querySelector('.content-area');
  contentArea.innerHTML = `
    <div class="container text-center mt-5">
      <div class="card p-5" style="background: #fff3f3; border: 2px solid #ef4444;">
        <h2 class="text-danger"><i class="fas fa-exclamation-triangle"></i> Se ha producido un error</h2>
        <p class="mt-3">No se pudieron cargar tus datos académicos.</p>
        <p><strong>Detalle:</strong> ${error}</p>
        <button class="btn btn-primary mt-3" onclick="window.location.reload();">
          <i class="fas fa-sync-alt"></i> Recargar Página
        </button>
      </div>
    </div>
  `;
}

</script>

